(window.webpackJsonp=window.webpackJsonp||[]).push([[237],{706:function(e,t,a){"use strict";a.r(t);var s=a(29),c=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"安装网络插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装网络插件"}},[e._v("#")]),e._v(" 安装网络插件"),a("Badge",{attrs:{text:"仅Master节点安装",type:"success"}})],1),e._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[e._v("注意")]),e._v(" "),a("p",[e._v("仅 Master 节点安装即可，工作节点无需安装")])]),e._v(" "),a("h2",{attrs:{id:"概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[e._v("#")]),e._v(" 概述")]),e._v(" "),a("p",[e._v("容器网络是容器选择连接到其他容器、主机和外部网络的机制。容器的 runtime 提供了各种网络模式，每种模式都会产生不同的体验。例如，Docker 默认情况下可以为容器配置以下网络：")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("none：")]),e._v(" 将容器添加到一个容器专门的网络堆栈中，没有对外连接。")]),e._v(" "),a("li",[a("strong",[e._v("host：")]),e._v(" 将容器添加到主机的网络堆栈中，没有隔离。")]),e._v(" "),a("li",[a("strong",[e._v("default bridge：")]),e._v(" 默认网络模式。每个容器可以通过 IP 地址相互连接。")]),e._v(" "),a("li",[a("strong",[e._v("自定义网桥：")]),e._v(" 用户定义的网桥，具有更多的灵活性、隔离性和其他便利功能。")])]),e._v(" "),a("h2",{attrs:{id:"什么是-cni"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是-cni"}},[e._v("#")]),e._v(" 什么是 CNI")]),e._v(" "),a("p",[e._v("CNI(Container Network Interface) 是一个标准的，通用的接口。在容器平台，Docker，Kubernetes，Mesos 容器网络解决方案 flannel，calico，weave。只要提供一个标准的接口，就能为同样满足该协议的所有容器平台提供网络功能，而 CNI 正是这样的一个标准接口协议。")]),e._v(" "),a("h2",{attrs:{id:"kubernetes-中的-cni-插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-中的-cni-插件"}},[e._v("#")]),e._v(" Kubernetes 中的 CNI 插件")]),e._v(" "),a("p",[e._v("CNI 的初衷是创建一个框架，用于在配置或销毁容器时动态配置适当的网络配置和资源。插件负责为接口配置和管理 IP 地址，并且通常提供与 IP 管理、每个容器的 IP 分配、以及多主机连接相关的功能。容器运行时会调用网络插件，从而在容器启动时分配 IP 地址并配置网络，并在删除容器时再次调用它以清理这些资源。")]),e._v(" "),a("p",[e._v("运行时或协调器决定了容器应该加入哪个网络以及它需要调用哪个插件。然后，插件会将接口添加到容器网络命名空间中，作为一个 veth 对的一侧。接着，它会在主机上进行更改，包括将 veth 的其他部分连接到网桥。再之后，它会通过调用单独的 IPAM（IP地址管理）插件来分配 IP 地址并设置路由。")]),e._v(" "),a("p",[e._v("在 Kubernetes 中，kubelet 可以在适当的时间调用它找到的插件，为通过 kubelet 启动的 pod进行自动的网络配置。")]),e._v(" "),a("p",[e._v("Kubernetes 中可选的 CNI 插件如下：")]),e._v(" "),a("ul",[a("li",[e._v("Flannel")]),e._v(" "),a("li",[e._v("Calico")]),e._v(" "),a("li",[e._v("Canal")]),e._v(" "),a("li",[e._v("Weave")])]),e._v(" "),a("h2",{attrs:{id:"什么是-calico"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是-calico"}},[e._v("#")]),e._v(" 什么是 Calico")]),e._v(" "),a("p",[e._v("Calico 为容器和虚拟机提供了安全的网络连接解决方案，并经过了大规模生产验证（在公有云和跨数千个集群节点中），可与 Kubernetes，OpenShift，Docker，Mesos，DC / OS 和 OpenStack 集成。")]),e._v(" "),a("p",[e._v("Calico 还提供网络安全规则的动态实施。使用 Calico 的简单策略语言，您可以实现对容器，虚拟机工作负载和裸机主机端点之间通信的细粒度控制。")]),e._v(" "),a("h2",{attrs:{id:"安装网络插件-calico"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装网络插件-calico"}},[e._v("#")]),e._v(" 安装网络插件 Calico")]),e._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[e._v("提示")]),e._v(" "),a("p",[e._v("截止到文章发表日期 2021 年 05 月 18 日，Calico 官方版本为 v3.18.3")])]),e._v(" "),a("p",[e._v("参考官方文档安装："),a("a",{attrs:{href:"https://docs.projectcalico.org/getting-started/kubernetes/",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://docs.projectcalico.org/getting-started/kubernetes/"),a("OutboundLink")],1)]),e._v(" "),a("h2",{attrs:{id:"下载配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下载配置文件"}},[e._v("#")]),e._v(" 下载配置文件")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("wget")]),e._v(" https://docs.projectcalico.org/manifests/calico.yaml\n")])])]),a("h2",{attrs:{id:"修改配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改配置"}},[e._v("#")]),e._v(" 修改配置")]),e._v(" "),a("p",[e._v("下载完后还需要修改里面定义Pod网络（CALICO_IPV4POOL_CIDR），与前面kubeadm init命令中使用的"),a("code",[e._v("--pod-network-cidr")]),e._v("选项指定的一样，大概在calico.yaml文件的第3684行左右（不同版本位置可能不一样）")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 找到如下内容")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# - name: CALICO_IPV4POOL_CIDR")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v('#   value: "192.168.0.0/16"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 去掉注释并替换为          ")]),e._v("\n            - name: CALICO_IPV4POOL_CIDR\n              value: "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"10.244.0.0/16"')]),e._v("\n")])])]),a("h2",{attrs:{id:"应用配置清单并部署网络插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#应用配置清单并部署网络插件"}},[e._v("#")]),e._v(" 应用配置清单并部署网络插件")]),e._v(" "),a("p",[e._v("在 Master 节点操作即可")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("kubectl apply -f calico.yaml\n")])])]),a("p",[e._v("安装时显示如下输出")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("ubuntu@k8s-master:~$ kubectl apply -f calico.yaml\nconfigmap/calico-config created\ncustomresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created\nclusterrole.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrole.rbac.authorization.k8s.io/calico-node created\nclusterrolebinding.rbac.authorization.k8s.io/calico-node created\ndaemonset.apps/calico-node created\nserviceaccount/calico-node created\ndeployment.apps/calico-kube-controllers created\nserviceaccount/calico-kube-controllers created\npoddisruptionbudget.policy/calico-kube-controllers created\n")])])]),a("h2",{attrs:{id:"确认安装是否成功"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#确认安装是否成功"}},[e._v("#")]),e._v(" 确认安装是否成功")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("kubectl get pod -n kube-system -l k8s-app"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("calico-node\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 需要等待所有状态为 Running，注意时间可能较久，3 - 5 分钟的样子")]),e._v("\nNAME                READY   STATUS    RESTARTS   AGE\ncalico-node-r52c6   "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          114s\n")])])]),a("p",[e._v("再次查看master节点状态已经为ready状态：")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("kubectl get nodes\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 控制台输出")]),e._v("\nNAME              STATUS   ROLES                  AGE   VERSION\nk8s-master   Ready    control-plane,master   16h   v1.20.0\n")])])]),a("p",[e._v("至此，Kubernetes 的 Master 节点就部署完成了。如果你只需要一个单节点的 Kubernetes，现在你就可以使用了。不过，在默认情况下，Kubernetes 的 Master 节点是不能运行用户 Pod 的。")]),e._v(" "),a("h2",{attrs:{id:"解决-imagepullbackoff"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决-imagepullbackoff"}},[e._v("#")]),e._v(" 解决 ImagePullBackOff")]),e._v(" "),a("p",[e._v("在使用 "),a("code",[e._v("watch kubectl get pods --all-namespaces")]),e._v(" 命令观察 Pods 状态时如果出现 "),a("code",[e._v("ImagePullBackOff")]),e._v(" 无法 Running 的情况，请尝试使用如下步骤处理：")]),e._v(" "),a("ul",[a("li",[e._v("Master 中删除 Nodes："),a("code",[e._v("kubectl delete nodes <NAME>")])]),e._v(" "),a("li",[e._v("Slave 中重置配置："),a("code",[e._v("kubeadm reset")])]),e._v(" "),a("li",[e._v("Slave 重启计算机："),a("code",[e._v("reboot")])]),e._v(" "),a("li",[e._v("Slave 重新加入集群："),a("code",[e._v("kubeadm join")])])])])}),[],!1,null,null,null);t.default=c.exports}}]);