(window.webpackJsonp=window.webpackJsonp||[]).push([[227],{696:function(a,t,s){"use strict";s.r(t);var r=s(29),e=Object(r.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"spring-boot-2-3-新特性-layered-jar"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spring-boot-2-3-新特性-layered-jar"}},[a._v("#")]),a._v(" Spring Boot 2.3 新特性 Layered Jar "),s("Badge",{attrs:{text:"推荐",type:"success"}})],1),a._v(" "),s("h2",{attrs:{id:"背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[a._v("#")]),a._v(" 背景")]),a._v(" "),s("p",[a._v("Spring Boot 2.3 为容器化部署提供了一个新特性 "),s("strong",[a._v("Layered Jar")]),a._v("。通常 Spring Boot 程序都是以 fat jar 的方式构建的，文件大小动辄 50M、100M 这样子，对 docker image 其实很不友好。Docker image 本身是分层结构，如果某一层没有变化在 "),s("code",[a._v("pull")]),a._v(" 时就不必上传，一旦有变化就要上传整层。一个程序中，程序自身代码、资源的变更频率要远大于依赖库的变更频率，大多数时候因为几行代码变化导致上传整个 jar 文件，无论是存储占用还是时间效率上都是很大的浪费，后者在国内网速下更是一个严重问题。")]),a._v(" "),s("h2",{attrs:{id:"layered-jar"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#layered-jar"}},[a._v("#")]),a._v(" Layered Jar")]),a._v(" "),s("p",[a._v("新特性 "),s("strong",[a._v("layered jar")]),a._v(" 为不同变更频率内容分离提供了支持工具，在此基础上分层构建 docker image 就变得很容易了。本质上这个特性是 "),s("code",[a._v("org.springframework.boot:spring-boot-maven-plugin")]),a._v(" 提供的一个新的 "),s("code",[a._v("layers")]),a._v(" 配置项，当启用 "),s("code",[a._v("layers")]),a._v(" 模式打包时，一个 "),s("code",[a._v("spring-boot-jarmode-layertools")]),a._v(" jar 会打包到 fat jar 中，新特性是由这个 jar 提供的。这里不深入解析实现细节，而是重点关注如何模式化使用这个特性获得收益。")]),a._v(" "),s("p",[a._v("要使用此功能，必须启用分层功能：")]),a._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("div",{staticClass:"highlight-lines"},[s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br")]),s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("project")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("plugins")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("plugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("org.springframework.boot"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("spring-boot-maven-plugin"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("configuration")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("layers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t\t\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("enabled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("true"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("enabled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("layers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("configuration")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("plugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("plugins")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("project")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n")])])]),s("p",[a._v("默认情况下，定义了以下层：")]),a._v(" "),s("ul",[s("li",[s("p",[s("code",[a._v("dependencies")]),a._v(" 对于版本"),s("strong",[a._v("不包含")]),a._v("的任何SNAPSHOT依赖项。")])]),a._v(" "),s("li",[s("p",[s("code",[a._v("spring-boot-loader")]),a._v(" 用于jar加载程序类。")])]),a._v(" "),s("li",[s("p",[s("code",[a._v("snapshot-dependencies")]),a._v(" 对于其版本"),s("strong",[a._v("包含")]),a._v("SNAPSHOT的任何依赖项。")])]),a._v(" "),s("li",[s("p",[s("code",[a._v("application")]),a._v(" 应用程序类和资源。")])])]),a._v(" "),s("p",[s("strong",[a._v("层顺序很重要")]),a._v("，因为它确定了部分应用程序更改时可以缓存先前的层的可能性。"),s("strong",[a._v("默认顺序为dependencies，spring-boot-loader，snapshot-dependencies，application")]),a._v("。应该首先添加最不可能更改的内容，然后添加更可能更改的层。")]),a._v(" "),s("p",[a._v("增加配置之后 "),s("code",[a._v("package")]),a._v(" 打包，然后可以执行以下命令验证配置正确与否")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ java -Djarmode"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("layertools -jar simplify-upms-biz.jar\n")])])]),s("p",[a._v("一个示例输出：")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("div",{staticClass:"highlight-lines"},[s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("br"),s("br")]),s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("Usage:\n  java -Djarmode=layertools -jar simplify-upms-biz.jar\n\nAvailable commands:\n  list     List layers from the jar that can be extracted\n  extract  Extracts layers from the jar for image creation\n  help     Help about any command\n")])])]),s("p",[a._v("该"),s("code",[a._v("extract")]),a._v("命令可用于轻松地将应用程序拆分为多个层，以添加到"),s("code",[a._v("Dockerfile")]),a._v("中。这是使用"),s("code",[a._v("jarmode")]),a._v("的"),s("code",[a._v("Dockerfile")]),a._v("的示例。")]),a._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("div",{staticClass:"highlight-lines"},[s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("br")]),s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" adoptopenjdk:11-jre-hotspot "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("as")]),a._v(" builder")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("WORKDIR")]),a._v(" application")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ARG")]),a._v(" JAR_FILE=target/*.jar")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("COPY")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${JAR_FILE}")]),a._v(" application.jar")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("RUN")]),a._v(" java -Djarmode=layertools -jar application.jar extract")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" adoptopenjdk:11-jre-hotspot")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("LABEL")]),a._v(" maintainer="),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"info@ieooc.com"')])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("LABEL")]),a._v(" version="),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"1.0"')])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("LABEL")]),a._v(" description="),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"simplify-upms-biz"')])]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ENV")]),a._v(" TZ=Asia/Shanghai")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("WORKDIR")]),a._v(" application")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("COPY")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token options"}},[s("span",{pre:!0,attrs:{class:"token property"}},[a._v("--from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("builder")])]),a._v(" application/dependencies/ ./")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("COPY")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token options"}},[s("span",{pre:!0,attrs:{class:"token property"}},[a._v("--from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("builder")])]),a._v(" application/spring-boot-loader/ ./")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("COPY")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token options"}},[s("span",{pre:!0,attrs:{class:"token property"}},[a._v("--from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("builder")])]),a._v(" application/snapshot-dependencies/ ./")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("COPY")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token options"}},[s("span",{pre:!0,attrs:{class:"token property"}},[a._v("--from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("builder")])]),a._v(" application/application/ ./")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("EXPOSE")]),a._v(" 4000")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ENTRYPOINT")]),a._v(" ["),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"java"')]),a._v(", "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"org.springframework.boot.loader.JarLauncher"')]),a._v("]")]),a._v("\n")])])]),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[a._v("注意")]),a._v(" "),s("p",[a._v("这是一个多阶段的"),s("code",[a._v("Dockerfile")]),a._v("。构建器阶段提取以后需要的目录。每个"),s("code",[a._v("COPY")]),a._v("命令都与"),s("code",[a._v("jarmode")]),a._v("提取的层有关。")])]),a._v(" "),s("p",[a._v("对上面的 "),s("code",[a._v("Dockerfile")]),a._v(" 逐行解释一下：")]),a._v(" "),s("ul",[s("li",[a._v("2 个 "),s("code",[a._v("FROM")]),a._v(" 保持统一为运行时使用的基础镜像即可；")]),a._v(" "),s("li",[a._v("目的文件保持 "),s("code",[a._v("application.jar")]),a._v(" 即可，它要跟 "),s("code",[a._v("java -Djarmode=layertools -jar")]),a._v("后面的文件名一致；")]),a._v(" "),s("li",[s("code",[a._v("LABEL")]),a._v("指定作者及版本信息，非必须项。但是算是 Spring Boot 容器化的良好实践")]),a._v(" "),s("li",[a._v("4 个 "),s("code",[a._v("COPY")]),a._v(" 1 个 "),s("code",[a._v("ENTRYPOINT")]),a._v(" 照抄即可，这是本文新特性的关键。")])]),a._v(" "),s("p",[a._v("然后，用这个 "),s("code",[a._v("Dockerfile")]),a._v(" 构建出来的镜像内容已经是拆解分成多层的镜像了，当变更源码、资源、快照版依赖、正式版依赖时会依次影响更多层镜像，从而实现每次构建上传仓库时存储和传输耗时最小化。")]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("提示")]),a._v(" "),s("p",[a._v("假设以上"),s("code",[a._v("Dockerfile")]),a._v("内容位于当前目录中，则可以使用构建docker映像"),s("code",[a._v("docker build .")]),a._v("，或者可以选择指定应用程序jar的路径，如以下示例所示：")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" build --build-arg "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("JAR_FILE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("./target/simplify-upms-biz.jar "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v(" -t simplify-upms-biz:v1.0\n")])])]),s("h2",{attrs:{id:"查看镜像分层信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看镜像分层信息"}},[a._v("#")]),a._v(" 查看镜像分层信息")]),a._v(" "),s("p",[a._v("我们通过"),s("code",[a._v("docker inspect simplify-upms-biz:v1.0")]),a._v("查看镜像的每层的散列值")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("div",{staticClass:"highlight-lines"},[s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("br"),s("br")]),s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('// simplify-upms-biz:v1.0 版本镜像分层信息摘要\n"Layers": [\n    "sha256:50644c29ef5a27c9a40c393a73ece2479de78325cae7d762ef3cdc19bf42dd0a",\n    "sha256:2104e5b926f69c4ad7a73be2c50541b8c2b8bd45ab882c9e5c4e388ccb556bef",\n    "sha256:f9a0984f718aa572e28dc4f776e4aa258f67e4f44ed5c63b6174962cc5617e78",\n    "sha256:d3f8c53ca74aa0fcc2e52c1ecd37f7507ccd6f8e63219ca60d05b94e68f524d5",\n    "sha256:2254b66d09be2cc6ae6feed4ea9f49dc4b14edaedbd7573d18d1f7d965389586",\n    "sha256:18bfcba3d17a9b06705a78c06cbc84e127f04a76fff70790af496b490b4a9e2e",\n    "sha256:28f08c714a6e10df22b986048e237dba87d850d25f4e03bea68cbf7de91b8841",\n    "sha256:e662f81e0c921b2a18dbe472d842185f2d767938b1118d83d4d1d2d1ce032e74",\n    "sha256:519d5530049b599f94a6ccbb15b4e659d01aa7b3f3bc18a772414a6c5aed0035"\n]\n')])])]),s("h2",{attrs:{id:"模块升级重新构建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#模块升级重新构建"}},[a._v("#")]),a._v(" 模块升级重新构建")]),a._v(" "),s("p",[a._v("我们对 simplify-upms-biz 程序进行部分修改（模拟开发过程），然后重新构建镜像")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" build --build-arg "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("JAR_FILE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("./target/simplify-upms-biz.jar "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v(" -t simplify-upms-biz:v1.1\n")])])]),s("p",[a._v("此时镜像分层信息如下 docker inspect simplify-upms-biz:v1.1")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("div",{staticClass:"highlight-lines"},[s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("br"),s("br")]),s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('// simplify-upms-biz:v1.1 版本镜像分层信息摘要\n"Layers": [\n    "sha256:50644c29ef5a27c9a40c393a73ece2479de78325cae7d762ef3cdc19bf42dd0a",\n    "sha256:2104e5b926f69c4ad7a73be2c50541b8c2b8bd45ab882c9e5c4e388ccb556bef",\n    "sha256:f9a0984f718aa572e28dc4f776e4aa258f67e4f44ed5c63b6174962cc5617e78",\n    "sha256:d3f8c53ca74aa0fcc2e52c1ecd37f7507ccd6f8e63219ca60d05b94e68f524d5",\n    "sha256:2254b66d09be2cc6ae6feed4ea9f49dc4b14edaedbd7573d18d1f7d965389586",\n    "sha256:18bfcba3d17a9b06705a78c06cbc84e127f04a76fff70790af496b490b4a9e2e",\n    "sha256:28f08c714a6e10df22b986048e237dba87d850d25f4e03bea68cbf7de91b8841",\n    "sha256:a1dc1f8cdf9ea2744fe64ecb20a9094ba8f094728c51b21ac6bf5e652916bdb0",\n    "sha256:f379fb50808d8e5483b276747d93b729308e7fe52de1d52c02a4912e6316c9fb"\n]\n')])])]),s("h2",{attrs:{id:"比较-v1-0、v1-1-镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#比较-v1-0、v1-1-镜像"}},[a._v("#")]),a._v(" 比较 v1.0、v1.1 镜像")]),a._v(" "),s("p",[a._v("通过比较 v1.0 和 v1.1 版本的镜像摘要信息，我们会发现只有最后的一层发生了变化，我们通过 "),s("a",{attrs:{href:"https://github.com/wagoodman/dive",target:"_blank",rel:"noopener noreferrer"}},[a._v("Dive 是一个用 Go 语言编写的 Docker 镜像分析工具"),s("OutboundLink")],1),a._v(" 来确定一下 最后一层是做了哪些事情")]),a._v(" "),s("p",[a._v("使用镜像分析工具进行分析")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run --rm -it "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -v /var/run/docker.sock:/var/run/docker.sock "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    wagoodman/dive:latest simplify-upms-biz\n")])])]),s("p",[a._v("分析内容输出如下：")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("div",{staticClass:"highlight-lines"},[s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("div",{staticClass:"highlighted"},[a._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br")]),s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('│ Layers ├────────────────────────────────────────────────────────────────────────────────────────── ┃ ● Current Layer Contents ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nCmp   Size  Command                                                                                  Permission     UID:GID       Size  Filetree\n    5.6 MB  FROM 31609b718dd2bed                                                                     -rw-r--r--         0:0      30 kB  │   │       ├── LatencyUtils-2.0.3.jar\n     12 MB  ALPINE_GLIBC_BASE_URL="https://github.com/sgerrand/alpine-pkg-glibc/releases/download" & -rw-r--r--         0:0     140 kB  │   │       ├── archaius-core-0.7.6.jar\n       0 B  mkdir -p /usr/lib/java/                                                                  -rw-r--r--         0:0     122 kB  │   │       ├── aspectjrt-1.9.6.jar\n    402 MB  #(nop) ADD file:65d2a21c343d4f40c5b76862829bee1b24ef58f2bd077129ce6e61765786a638 in .    -rw-r--r--         0:0     2.1 MB  │   │       ├── aspectjweaver-1.9.6.jar\n       0 B  WORKDIR /application                                                                     -rw-r--r--         0:0     878 kB  │   │       ├── bcpkix-jdk15on-1.64.jar\n     76 MB  COPY application/dependencies/ ./ # buildkit                                             -rw-r--r--         0:0     4.8 MB  │   │       ├── bcprov-jdk15on-1.64.jar\n    240 kB  COPY application/spring-boot-loader/ ./ # buildkit                                       -rw-r--r--         0:0     3.5 MB  │   │       ├── byte-buddy-1.10.18.jar\n     82 kB  COPY application/snapshot-dependencies/ ./ # buildkit                                    -rw-r--r--         0:0     201 kB  │   │       ├── checker-qual-2.11.1.jar\n    108 kB  COPY application/application/ ./ # buildkit                                              -rw-r--r--         0:0     505 kB  │   │       ├── classgraph-4.8.83.jar\n                                                                                                     -rw-r--r--         0:0      68 kB  │   │       ├── classmate-1.5.1.jar\n│ Layer Details ├─────────────────────────────────────────────────────────────────────────────────── -rw-r--r--         0:0     348 kB  │   │       ├── commons-codec-1.14.jar\n                                                                                                     -rw-r--r--         0:0     588 kB  │   │       ├── commons-collections-3.2.2.jar\nTags:   (unavailable)                                                                                -rw-r--r--         0:0     354 kB  │   │       ├── commons-configuration-1.8.jar\nId:     bc864cc37f3f9cc88d08849efd54796b8f69644cfa4c3cc45cb49e66c7af381f                             -rw-r--r--         0:0      72 kB  │   │       ├── commons-fileupload-1.4.jar\nDigest: sha256:519d5530049b599f94a6ccbb15b4e659d01aa7b3f3bc18a772414a6c5aed0035                      -rw-r--r--         0:0     174 kB  │   │       ├── commons-io-2.2.jar\nCommand:                                                                                             -rw-r--r--         0:0     284 kB  │   │       ├── commons-lang-2.6.jar\nCOPY application/application/ ./ # buildkit                                                          -rw-r--r--         0:0     117 kB  │   │       ├── concurrentlinkedhashmap-lru-1.4.2.jar\n                                                                                                     -rw-r--r--         0:0     3.5 MB  │   │       ├── druid-1.2.3.jar\n│ Image Details ├─────────────────────────────────────────────────────────────────────────────────── -rw-r--r--         0:0      20 kB  │   │       ├── druid-spring-boot-starter-1.2.3.jar\n                                                                                                     -rw-r--r--         0:0      14 kB  │   │       ├── error_prone_annotations-2.3.4.jar\n                                                                                                     -rw-r--r--         0:0     4.6 kB  │   │       ├── failureaccess-1.0.1.jar\nTotal Image size: 497 MB                                                                             -rw-r--r--         0:0     652 kB  │   │       ├── fastjson-1.2.71.jar\nPotential wasted space: 483 kB                                                                       -rw-r--r--         0:0     189 kB  │   │       ├── feign-core-10.10.1.jar\nImage efficiency score: 99 %                                                                         -rw-r--r--         0:0      30 kB  │   │       ├── feign-form-3.8.0.jar\n                                                                                                     -rw-r--r--         0:0      14 kB  │   │       ├── feign-form-spring-3.8.0.jar\nCount   Total Space  Path                                                                            -rw-r--r--         0:0      18 kB  │   │       ├── feign-hystrix-10.10.1.jar\n    2        430 kB  /etc/ssl/certs/ca-certificates.crt                                              -rw-r--r--         0:0     3.7 kB  │   │       ├── feign-slf4j-10.10.1.jar\n    2         30 kB  /lib/apk/db/installed                                                           -rw-r--r--         0:0     1.7 MB  │   │       ├── freemarker-2.3.30.jar\n    2         22 kB  /lib/apk/db/scripts.tar                                                         -rw-r--r--         0:0     2.8 MB  │   │       ├── guava-29.0-jre.jar\n    2         219 B  /lib/apk/db/triggers                                                            -rw-r--r--         0:0     1.3 MB  │   │       ├── hibernate-validator-6.1.6.Final.jar\n    2         198 B  /etc/apk/world                                                                  -rw-r--r--         0:0     180 kB  │   │       ├── httpasyncclient-4.1.4.jar\n    2           0 B  /var/cache/misc                                                                 -rw-r--r--         0:0     780 kB  │   │       ├── httpclient-4.5.13.jar\n    2           0 B  /lib/apk/db/lock                                                                -rw-r--r--         0:0     328 kB  │   │       ├── httpcore-4.4.14.jar\n    2           0 B  /usr/local/share                                                                -rw-r--r--         0:0     369 kB  │   │       ├── httpcore-nio-4.4.14.jar\n    2           0 B  /usr/bin/wget                                                                   -rw-r--r--         0:0     1.8 MB  │   │       ├── hutool-all-5.4.5.jar\n    2           0 B  /root                                                                           -rw-r--r--         0:0     468 kB  │   │       ├── hystrix-core-1.5.18.jar\n    2           0 B  /etc/apk/protected_paths.d                                                      -rw-r--r--         0:0     8.8 kB  │   │       ├── j2objc-annotations-1.3.jar\n')])])]),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[a._v("#")]),a._v(" 总结")]),a._v(" "),s("p",[a._v("无论从易用程度还是达到的效果上讲，layered jar 都非常值得使用。要使用该特性只需要开启 pom 中一个配置项并使用一个几乎不需要任何修改的 "),s("code",[a._v("Dockerfile")]),a._v(" 模板，几乎零负担获得可观的收益。")])])}),[],!1,null,null,null);t.default=e.exports}}]);