(window.webpackJsonp=window.webpackJsonp||[]).push([[238],{707:function(s,t,a){"use strict";a.r(t);var e=a(29),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"使用-kubeadm-配置-worker-节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-kubeadm-配置-worker-节点"}},[s._v("#")]),s._v(" 使用 kubeadm 配置 Worker 节点")]),s._v(" "),a("h2",{attrs:{id:"概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),a("p",[s._v("部署worker节点 Kubernetes 的 Worker 节点跟 Master 节点几乎是相同的，它们运行着的都是一个 kubelet 组件。唯一的区别在于，在 kubeadm init 的过程中，kubelet 启动后，Master 节点上还会自动运行 kube-apiserver、kube-scheduler、kube-controller-manger 这三个系统 Pod。 在 k8s-node1 和 k8s-node2 上分别执行如下命令，将其注册到 Cluster 中：")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("切换到 Worker 节点，执行如下命令加入集群，"),a("strong",[s._v("注意使用root用户执行命令")])])]),s._v(" "),a("h2",{attrs:{id:"加入集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#加入集群"}},[s._v("#")]),s._v(" 加入集群")]),s._v(" "),a("p",[s._v("执行以下命令将节点接入集群")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubeadm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.101:6443 --token abcdef.0123456789abcdef "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --discovery-token-ca-cert-hash sha256:cff67f08d748fb39c91199ce5515817dfffc5e6dd8a94448693fd3cbb6885eb3 \n")])])]),a("p",[s._v("如果执行kubeadm init时没有记录下加入集群的命令，可以通过以下命令重新创建 "),a("code",[s._v("kubeadm token create --print-join-command")]),s._v(" 在k8s-node1上执行kubeadm join ：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("root@k8s-node1:/home/heyuqiang"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm join 192.168.31.101:6443 --token abcdef.0123456789abcdef \\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("     --discovery-token-ca-cert-hash sha256:cff67f08d748fb39c91199ce5515817dfffc5e6dd8a94448693fd3cbb6885eb3 \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Running pre-flight checks\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING SystemVerification"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": this Docker version is not on the list of validated versions: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.10")]),s._v(".0. Latest validated version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19.03")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Reading configuration from the cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" FYI: You can "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("look")]),s._v(" at this config "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" with "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl -n kube-system get cm kubeadm-config -o yaml'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Writing kubelet configuration to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/kubelet/config.yaml"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Writing kubelet environment "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" with flags to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/kubelet/kubeadm-flags.env"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Starting the kubelet\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Waiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the kubelet to perform the TLS Bootstrap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nThis "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl get nodes'")]),s._v(" on the control-plane to see this "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" the cluster.\n")])])]),a("p",[s._v("重复执行以上操作将k8s-node2也加进去（注意重新执行"),a("code",[s._v("kubeadm token create --print-join-command")]),s._v("）。 然后根据提示，我们可以通过 "),a("code",[s._v("kubectl get nodes")]),s._v(" 查看节点的状态：")]),s._v(" "),a("p",[s._v("说明：")]),s._v(" "),a("ul",[a("li",[s._v("token\n"),a("ul",[a("li",[s._v("可以通过安装 master 时的日志查看 token 信息")]),s._v(" "),a("li",[s._v("可以通过 "),a("code",[s._v("kubeadm token list")]),s._v(" 命令打印出 token 信息")]),s._v(" "),a("li",[s._v("如果 token 过期，可以使用 "),a("code",[s._v("kubeadm token create")]),s._v(" 命令创建新的 token")])])]),s._v(" "),a("li",[s._v("discovery-token-ca-cert-hash\n"),a("ul",[a("li",[s._v("可以通过安装 master 时的日志查看 sha256 信息")]),s._v(" "),a("li",[s._v("可以通过 "),a("code",[s._v("openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'")]),s._v(" 命令查看 sha256 信息")])])])]),s._v(" "),a("h2",{attrs:{id:"验证是否成功"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#验证是否成功"}},[s._v("#")]),s._v(" 验证是否成功")]),s._v(" "),a("p",[a("strong",[s._v("回到 k8s-master 服务器")]),s._v(",可以看到 node 成功加入 master")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("ubuntu@k8s-master:~$ kubectl get nodes \nNAME              STATUS   ROLES                  AGE     VERSION\nk8s-master   Ready    control-plane,master   16h     v1.20.0\nk8s-node1    Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                 2m35s   v1.20.0\nk8s-node2    Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                 80s     v1.20.0\n")])])]),a("h2",{attrs:{id:"配置kubectl命令自动补全功能"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置kubectl命令自动补全功能"}},[s._v("#")]),s._v(" 配置kubectl命令自动补全功能")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"source <(kubectl completion bash)"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ~/.profile\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("如果 node 节点加入 master 时配置有问题可以在 node 节点上使用 "),a("code",[s._v("kubeadm reset")]),s._v(" 重置配置再使用 "),a("code",[s._v("kubeadm join")]),s._v(" 命令重新加入即可。希望在 master 节点删除 node ，可以使用 "),a("code",[s._v("kubeadm delete nodes")]),s._v(" 删除。")])]),s._v(" "),a("p",[s._v("nodes状态全部为ready，由于每个节点都需要启动若干组件，如果node节点的状态是 NotReady，可以查看所有节点pod状态，确保所有pod成功拉取到镜像并处于running状态：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get pod --all-namespaces -o wide\nNAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE     IP              NODE              NOMINATED NODE   READINESS GATES\nkube-system   calico-kube-controllers-6d7b4db76c-76gqb   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          11m     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".98.194   k8s-master   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   calico-node-bnsp4                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3m37s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.17")]),s._v(".8.82      k8s-node2    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   calico-node-cptwc                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4m52s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.102      k8s-node1    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   calico-node-r52c6                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          11m     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.101      k8s-master   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   coredns-7f89b7bc75-d4drw                   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          16h     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".98.195   k8s-master   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   coredns-7f89b7bc75-xzjfp                   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          16h     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".98.193   k8s-master   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   etcd-k8s-master                       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          16h     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.101      k8s-master   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-apiserver-k8s-master             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          16h     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.101      k8s-master   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-controller-manager-k8s-master    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          16h     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.101      k8s-master   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-proxy-2cffv                           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3m37s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.17")]),s._v(".8.82      k8s-node2    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-proxy-55q6f                           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          16h     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.101      k8s-master   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-proxy-kg6m7                           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4m52s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.102      k8s-node1    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-scheduler-k8s-master             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          16h     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.101      k8s-master   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])]),a("p",[s._v("这时，所有的节点都已经 Ready，Kubernetes Cluster 创建成功，一切准备就绪。 如果pod状态为Pending、ContainerCreating、ImagePullBackOff 都表明 Pod 没有就绪，Running 才是就绪状态。 如果有pod提示Init:ImagePullBackOff，说明这个pod的镜像在对应节点上拉取失败，我们可以通过 kubectl describe pod 查看 Pod 具体情况，以确认拉取失败的镜像：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl describe pod calico-node-lh5j2 --namespace"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-system\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nEvents:\n  Type     Reason     Age    From               Message\n  ----     ------     ----   ----               -------\n  Normal   Scheduled  4m56s  default-scheduler  Successfully assigned kube-system/calico-node-bnsp4 to k8s-node2\n  Normal   Pulling    4m45s  kubelet            Pulling image "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker.io/calico/cni:v3.19.0"')]),s._v("\n  Normal   Pulled     4m7s   kubelet            Successfully pulled image "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker.io/calico/cni:v3.19.0"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("38")]),s._v(".679699261s\n  Normal   Created    4m6s   kubelet            Created container upgrade-ipam\n  Normal   Started    4m6s   kubelet            Started container upgrade-ipam\n  Normal   Pulled     4m5s   kubelet            Container image "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker.io/calico/cni:v3.19.0"')]),s._v(" already present on machine\n  Normal   Created    4m4s   kubelet            Created container install-cni\n  Normal   Started    4m4s   kubelet            Started container install-cni\n  Normal   Pulling    3m56s  kubelet            Pulling image "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker.io/calico/pod2daemon-flexvol:v3.19.0"')]),s._v("\n  Normal   Pulled     2m29s  kubelet            Successfully pulled image "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker.io/calico/pod2daemon-flexvol:v3.19.0"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" 1m26.543216669s\n  Normal   Created    2m28s  kubelet            Created container flexvol-driver\n  Normal   Started    2m27s  kubelet            Started container flexvol-driver\n  Normal   Pulling    2m26s  kubelet            Pulling image "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker.io/calico/node:v3.19.0"')]),s._v("\n  Normal   Pulled     101s   kubelet            Successfully pulled image "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker.io/calico/node:v3.19.0"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v(".442030701s\n  Normal   Created    100s   kubelet            Created container calico-node\n  Normal   Started    100s   kubelet            Started container calico-node\n  Warning  Unhealthy  96s    kubelet            Readiness probe failed: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-05-21 01:38:10.203 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("149")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" confd/health.go "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("180")]),s._v(": Number of node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" with BGP peering established "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ncalico/node is not ready: BIRD is not ready: BGP not established with "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.101,192.168.31.102\n")])])]),a("p",[s._v("查看master节点下载了哪些镜像")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" images\nREPOSITORY                                                        TAG        IMAGE ID       CREATED         SIZE\ncalico/node                                                       v3.19.0    b0744cc52c19   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago     153MB\ncalico/pod2daemon-flexvol                                         v3.19.0    a5decf77918d   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(".7MB\ncalico/cni                                                        v3.19.0    3d17cd6307a4   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago     146MB\ncalico/kube-controllers                                           v3.19.0    c51610d08fdf   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(".6MB\nregistry.aliyuncs.com/google_containers/kube-proxy                v1.20.0    10cc881966cf   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" months ago    118MB\nregistry.aliyuncs.com/google_containers/kube-apiserver            v1.20.0    ca9843d3b545   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" months ago    122MB\nregistry.aliyuncs.com/google_containers/kube-scheduler            v1.20.0    3138b6e3d471   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" months ago    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("46")]),s._v(".4MB\nregistry.aliyuncs.com/google_containers/kube-controller-manager   v1.20.0    b9fa1895dcaa   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" months ago    116MB\nregistry.aliyuncs.com/google_containers/etcd                      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.4")]),s._v(".13-0   0369cf4303ff   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" months ago    253MB\nregistry.aliyuncs.com/google_containers/coredns                   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.7")]),s._v(".0      bfe3a36ebd25   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" months ago   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),s._v(".2MB\nregistry.aliyuncs.com/google_containers/pause                     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.2")]),s._v("        80d28bedfe5d   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" months ago   683kB\n")])])]),a("p",[s._v("查看worker节点下载了哪些镜像：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("ubuntu@k8s-node1:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" images\nREPOSITORY                                           TAG       IMAGE ID       CREATED         SIZE\ncalico/node                                          v3.19.0   b0744cc52c19   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago     153MB\ncalico/pod2daemon-flexvol                            v3.19.0   a5decf77918d   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(".7MB\ncalico/cni                                           v3.19.0   3d17cd6307a4   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago     146MB\nregistry.aliyuncs.com/google_containers/kube-proxy   v1.20.0   10cc881966cf   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" months ago    118MB\nregistry.aliyuncs.com/google_containers/pause        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.2")]),s._v("       80d28bedfe5d   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" months ago   683kB\n")])])]),a("h2",{attrs:{id:"测试集群各个组件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试集群各个组件"}},[s._v("#")]),s._v(" 测试集群各个组件")]),s._v(" "),a("p",[s._v("首先验证"),a("code",[s._v("kube-apiserver")]),s._v(", "),a("code",[s._v("kube-controller-manager")]),s._v(", "),a("code",[s._v("kube-scheduler")]),s._v(", "),a("code",[s._v("pod network")]),s._v(" 是否正常： 部署一个 Nginx Deployment，包含2个Pod 参考："),a("a",{attrs:{href:"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://kubernetes.io/docs/concepts/workloads/controllers/deployment/"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl create deployment nginx --image"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:alpine\ndeployment.apps/nginx created\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl scale deployment nginx --replicas"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\ndeployment.apps/nginx scaled\n")])])]),a("p",[s._v("验证Nginx Pod是否正确运行，并且会分配10.244.开头的集群IP")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get pods -l "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx -o wide      \nNAME                     READY   STATUS    RESTARTS   AGE   IP              NODE             NOMINATED NODE   READINESS GATES\nnginx-565785f75c-6bjgm   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          45s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".86.1     k8s-node1   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nnginx-565785f75c-qdnbg   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          22s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".156.65   k8s-node2   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])]),a("h2",{attrs:{id:"验证kube-proxy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#验证kube-proxy"}},[s._v("#")]),s._v(" 验证kube-proxy")]),s._v(" "),a("p",[s._v("以 NodePort 方式对外提供服务 参考："),a("a",{attrs:{href:"https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl expose deployment nginx --port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" --type"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NodePort\nservice/nginx exposed\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get services nginx\nNAME    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("        AGE\nnginx   NodePort   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.108")]),s._v(".73.221   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":31622/TCP   25s\n")])])]),a("p",[s._v("可以通过任意 NodeIP:Port 在集群外部访问这个服务：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.101:31622\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.102:31622\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".31.103:31622\n")])])]),a("p",[s._v("最后验证一下dns, pod network是否正常： 运行Busybox并进入交互模式")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl run -it "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" --image"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("radial/busyboxplus:curl\nIf you don't see a "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" prompt, try pressing enter.\n")])])]),a("p",[s._v("输入nslookup nginx查看是否可以正确解析出集群内的IP，以验证DNS是否正常")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" root@curl:/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nslookup")]),s._v(" nginx\nServer:    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.10\nAddress "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.10 kube-dns.kube-system.svc.cluster.local\n\nName:      nginx\nAddress "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.108")]),s._v(".73.221 nginx.default.svc.cluster.local\n")])])]),a("p",[s._v("通过服务名进行访问，验证kube-proxy是否正常")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" root@curl:/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://nginx/\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("DOCTYPE html"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("html"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("head"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("title"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("Welcome to nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/title"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/body"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/html"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 分别访问一下2个Pod的内网IP，验证跨Node的网络通信是否正常")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" root@curl:/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".86.1\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("DOCTYPE html"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("html"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("head"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("title"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("Welcome to nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/title"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/body"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/html"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" root@curl:/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".156.65\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("DOCTYPE html"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("html"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("head"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("title"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("Welcome to nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/title"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/body"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/html"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])]),a("h2",{attrs:{id:"停止服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#停止服务"}},[s._v("#")]),s._v(" 停止服务")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl delete deployment nginx\ndeployment.apps "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx"')]),s._v(" deleted\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl delete "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" nginx\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx"')]),s._v(" deleted\n")])])]),a("h2",{attrs:{id:"pod调度到master节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pod调度到master节点"}},[s._v("#")]),s._v(" Pod调度到Master节点")]),s._v(" "),a("p",[s._v("出于安全考虑，默认配置下Kubernetes不会将Pod调度到Master节点。查看Taints字段默认配置：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl describe "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-master \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nTaints:             node-role.kubernetes.io/master:NoSchedule\n")])])]),a("p",[s._v("如果希望将k8s-master也当作Node节点使用，可以执行如下命令,其中k8s-master是主机节点hostname：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl taint "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-master node-role.kubernetes.io/master-\n")])])]),a("p",[s._v("修改后Taints字段状态：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl describe "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-master                             \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nTaints:             "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])]),a("p",[s._v("如果要恢复Master Only状态，执行如下命令：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl taint "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-master node-role.kubernetes.io/master"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(":NoSchedule\n")])])]),a("h2",{attrs:{id:"kube-proxy开启ipvs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kube-proxy开启ipvs"}},[s._v("#")]),s._v(" kube-proxy开启ipvs")]),s._v(" "),a("p",[s._v("修改ConfigMap的kube-system/kube-proxy中的config.conf，mode: “ipvs”：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl edit cm kube-proxy -n kube-system\nconfigmap/kube-proxy edited\n之后重启各个节点上的kube-proxy pod\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get pod -n kube-system "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kube-proxy "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{system("kubectl delete pod "$1" -n kube-system")}\'')]),s._v("\npod "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kube-proxy-2w9sh"')]),s._v(" deleted\npod "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kube-proxy-gw4lx"')]),s._v(" deleted\npod "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kube-proxy-thv4c"')]),s._v(" deleted\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get pod -n kube-system "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kube-proxy\nkube-proxy-6qlgv                        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          65s\nkube-proxy-fdtjd                        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          47s\nkube-proxy-m8zkx                        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          52s\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$\n")])])]),a("p",[s._v("查看日志：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl logs kube-proxy-6qlgv -n kube-system\nI1213 09:50:15.414493       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" server_others.go:189"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Using ipvs Proxier.\nW1213 09:50:15.414908       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" proxier.go:365"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" IPVS scheduler not specified, use rr by default\nI1213 09:50:15.415021       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" server_others.go:216"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Tearing down inactive rules.\nI1213 09:50:15.461658       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" server.go:464"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Version: v1.13.0\nI1213 09:50:15.467827       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" conntrack.go:52"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Setting nf_conntrack_max to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\nI1213 09:50:15.467997       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" config.go:202"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Starting "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" config controller\nI1213 09:50:15.468010       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" controller_utils.go:1027"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Waiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" caches to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sync")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" config controller\nI1213 09:50:15.468092       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" config.go:102"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Starting endpoints config controller\nI1213 09:50:15.468100       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" controller_utils.go:1027"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Waiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" caches to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sync")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" endpoints config controller\nI1213 09:50:15.568766       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" controller_utils.go:1034"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Caches are synced "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" endpoints config controller\nI1213 09:50:15.568950       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" controller_utils.go:1034"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Caches are synced "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" config controller\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ubuntu@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$\n")])])]),a("p",[s._v("日志中打印出了Using ipvs Proxier，说明ipvs模式已经开启。")]),s._v(" "),a("p",[s._v("至此，1个Master，并附带2个Node的kubernetes集群基础设置已经部署完成，并且其核心功能可以正常使用。")]),s._v(" "),a("h2",{attrs:{id:"移除节点和集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#移除节点和集群"}},[s._v("#")]),s._v(" 移除节点和集群")]),s._v(" "),a("p",[s._v("kubernetes集群移除节点，以移除k8s-node2节点为例，在Master节点上运行：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl drain k8s-node2 --delete-local-data --force --ignore-daemonsets\nkubectl delete "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-node2\n")])])]),a("p",[s._v("上面两条命令执行完成后，在k8s-node2节点执行清理命令，重置kubeadm的安装状态：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubeadm reset\n")])])]),a("p",[s._v("在master上删除node并不会清理k8s-node2运行的容器，需要在删除节点上面手动运行清理命令。\n如果你想重新配置集群，使用新的参数重新运行"),a("code",[s._v("kubeadm init")]),s._v("或者"),a("code",[s._v("kubeadm join")]),s._v("即可。")]),s._v(" "),a("p",[s._v("至此3个节点的集群搭建完成，后续可以继续添加node节点，或者部署"),a("code",[s._v("dashboard")]),s._v("、"),a("code",[s._v("helm")]),s._v("包管理工具、"),a("code",[s._v("EFK")]),s._v("日志系统、"),a("code",[s._v("Prometheus Operator")]),s._v("监控系统、"),a("code",[s._v("rook+ceph")]),s._v("存储系统等组件。")])])}),[],!1,null,null,null);t.default=n.exports}}]);