(window.webpackJsonp=window.webpackJsonp||[]).push([[235],{704:function(t,a,s){"use strict";s.r(a);var e=s(29),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"配置-kubeadm"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置-kubeadm"}},[t._v("#")]),t._v(" 配置 kubeadm")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),s("p",[t._v("仅在Master节点上操作")])]),t._v(" "),s("h2",{attrs:{id:"概述"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[t._v("#")]),t._v(" 概述")]),t._v(" "),s("p",[t._v("kubeadm已经进入GA阶段，其控制面初始化和加入节点步骤都支持大量可定制内容，因此kubeadm还提供了配置文件功能用于复杂定制。同时，kubeadm将配置文件以ConfigMap的形式保存到集群中，便于后续的查询和升级工作。"),s("code",[t._v("kubeadm config")]),t._v("子命令提供了对这一组功能的支持：")]),t._v(" "),s("ul",[s("li",[t._v("kubeadm config upload from-file：由配置文件上传到集群中生成ConfigMap。")]),t._v(" "),s("li",[t._v("kubeadm config upload from-flags：由配置参数生成ConfigMap。")]),t._v(" "),s("li",[t._v("kubeadm config view：查看当前集群中的配置值。")]),t._v(" "),s("li",[t._v("kubeadm config print init-defaults：输出kubeadm init默认参数文件的内容。")]),t._v(" "),s("li",[t._v("kubeadm config print join-defaults：输出kubeadm join默认参数文件的内容。")]),t._v(" "),s("li",[t._v("kubeadm config migrate：在新旧版本之间进行配置转换。")]),t._v(" "),s("li",[t._v("kubeadm config images list：列出所需的镜像列表。")]),t._v(" "),s("li",[t._v("kubeadm config images pull：拉取镜像到本地。")])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("官方文档")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/",target:"_blank",rel:"noopener noreferrer"}},[t._v("kubeadm init"),s("OutboundLink")],1),t._v(" "),s("a",{attrs:{href:"https://pkg.go.dev/k8s.io/kubernetes@v1.20.4/cmd/kubeadm/app/apis/kubeadm/v1beta2",target:"_blank",rel:"noopener noreferrer"}},[t._v("打印配置"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("有两种方式可以初始化Master节点，分别是命令行方式和配置文件方式，这里"),s("strong",[t._v("推荐使用通过配置文件方式")])]),t._v(" "),s("h2",{attrs:{id:"通过配置文件方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#通过配置文件方式"}},[t._v("#")]),t._v(" 通过配置文件方式"),s("Badge",{attrs:{text:"推荐",type:"success"}})],1),t._v(" "),s("p",[t._v("导出配置文件")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("kubeadm config print init-defaults "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" init-config.yaml\n")])])]),s("p",[t._v("修改配置为如下内容")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("div",{staticClass:"highlight-lines"},[s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("br")]),s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubeadm.k8s.io/v1beta2\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("bootstrapTokens")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("groups")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" system"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("bootstrappers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("kubeadm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("default"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("token\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("token")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" abcdef.0123456789abcdef\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ttl")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 24h0m0s\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("usages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" signing\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" authentication\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" InitConfiguration\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("localAPIEndpoint")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改为主节点 IP")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("advertiseAddress")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 192.168.31.101\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("bindPort")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6443")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodeRegistration")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("criSocket")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /var/run/dockershim.sock\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" k8s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("master\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("taints")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("effect")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" NoSchedule\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("role.kubernetes.io/master\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiServer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeoutForControlPlane")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 4m0s\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubeadm.k8s.io/v1beta2\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 控制平面的接入端点，我们这里选择适配到192.168.31.101这一IP上")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("controlPlaneEndpoint")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.31.101:6443"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("certificatesDir")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /etc/kubernetes/pki\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("clusterName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubernetes\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("controllerManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dns")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" CoreDNS\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("local")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dataDir")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /var/lib/etcd\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 国内不能访问 Google，修改为阿里云")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("imageRepository")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" registry.aliyuncs.com/google_containers\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ClusterConfiguration\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 版本号要与部署的目标版本保持一致")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kubernetesVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1.20.0\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networking")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dnsDomain")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cluster.local\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置成 Calico 的默认网段")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("podSubnet")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10.244.0.0/16\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("serviceSubnet")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10.96.0.0/12\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scheduler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("将上面的内容保存为"),s("code",[t._v("init-config.yaml")]),t._v("备用。")]),t._v(" "),s("h2",{attrs:{id:"查看和拉取镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看和拉取镜像"}},[t._v("#")]),t._v(" 查看和拉取镜像")]),t._v(" "),s("p",[t._v("查看所需镜像列表")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("kubeadm config images list --config init-config.yaml\n")])])]),s("p",[t._v("拉取镜像")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("kubeadm config images pull --config init-config.yaml\n")])])]),s("p",[t._v("查看镜像")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("root@k8s-master:/home/heyuqiang"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker images ")]),t._v("\nREPOSITORY                                                        TAG        IMAGE ID       CREATED         SIZE\nregistry.aliyuncs.com/google_containers/kube-proxy                v1.20.0    10cc881966cf   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" months ago    118MB\nregistry.aliyuncs.com/google_containers/kube-scheduler            v1.20.0    3138b6e3d471   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" months ago    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("46")]),t._v(".4MB\nregistry.aliyuncs.com/google_containers/kube-apiserver            v1.20.0    ca9843d3b545   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" months ago    122MB\nregistry.aliyuncs.com/google_containers/kube-controller-manager   v1.20.0    b9fa1895dcaa   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" months ago    116MB\nregistry.aliyuncs.com/google_containers/etcd                      "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.4")]),t._v(".13-0   0369cf4303ff   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" months ago    253MB\nregistry.aliyuncs.com/google_containers/coredns                   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.7")]),t._v(".0      bfe3a36ebd25   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(" months ago   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("45")]),t._v(".2MB\nregistry.aliyuncs.com/google_containers/pause                     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.2")]),t._v("        80d28bedfe5d   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(" months ago   683kB\n")])])]),s("p",[t._v("在镜像下载完成之后，就可以进行安装了。")]),t._v(" "),s("h2",{attrs:{id:"通过命令行方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#通过命令行方式"}},[t._v("#")]),t._v(" 通过命令行方式"),s("Badge",{attrs:{text:"不推荐",type:"error"}})],1),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubeadm init ")]),t._v("\n--apiserver-advertise-address"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101\n--image-repository registry.aliyuncs.com/google_containers \n--kubernetes-version"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("v1.20.0 \n--service-cidr"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.0/12 \n--pod-network-cidr"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.0/16 \n--token-ttl"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n")])])]),s("p",[t._v("命令中的各选项简单说明如下：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("--apiserver-advertise-address：apiserver通告给其它组件的IP地址，一般应该为Master节点用于集群内部通信的IP地址")])]),t._v(" "),s("li",[s("p",[t._v("--image-repository：指定要使用的镜像仓库，默认为gcr.io")])]),t._v(" "),s("li",[s("p",[t._v("kubernetes-version：kubernetes程序组件的版本号，必须要与前面安装的版本一致")])]),t._v(" "),s("li",[s("p",[t._v("--service-cidr：集群内部虚拟网络，Pod统一访问入口；service的网络地址范围，其值为CIDR格式的网络地址，默认地址为10.96.0.0/12")])]),t._v(" "),s("li",[s("p",[t._v("--pod-network-cidr：Pod网络的地址范围，其值为CIDR格式的网络地址，通常，Flannel网络插件的默认为10.244.0.0/16，Project Calico插件的默认值为192.168.0.0/16；本章使用的是calico插件，所以下面部署CNI网络插件时需要与这里设置的保持一致。")])]),t._v(" "),s("li",[s("p",[t._v("--token-ttl：共享令牌（token）的过期时长，默认为24小时，0表示永不过期；为防止不安全存储等原因导致的令牌泄露危及集群安全，建议为其设定过期时长。未设定该选项时，在token过期后，若期望再向集群中加入其它节点，可以使用如下命令重新创建 token，并生成节点加入命令。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("kubeadm token create --print-join-command\n")])])])])])])}),[],!1,null,null,null);a.default=n.exports}}]);