(window.webpackJsonp=window.webpackJsonp||[]).push([[236],{705:function(t,s,n){"use strict";n.r(s);var e=n(29),a=Object(e.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"使用-kubeadm-部署-master-节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用-kubeadm-部署-master-节点"}},[t._v("#")]),t._v(" 使用 kubeadm 部署 Master 节点")]),t._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),n("p",[t._v("仅在Master节点上操作")])]),t._v(" "),n("h2",{attrs:{id:"运行-kubeadm-init-命令安装-master"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#运行-kubeadm-init-命令安装-master"}},[t._v("#")]),t._v(" 运行 kubeadm init 命令安装 Master")]),t._v(" "),n("p",[t._v("至此，准备工作已经就绪。执行 kubeadm init 命令即可一键安装 Kubernetes 的 Master。")]),t._v(" "),n("p",[t._v("在开始之前需要注意：kubeadm 的安装过程不涉及网络插件（CNI）的初始化，因此 kubeadm 初步安装完成的集群不具备网络功能，任何 Pod 包括自带的 CoreDNS 都无法正常工作。而网络插件的安装往往对 kubeadm init 命令的参数有一定的要求。例如，安装 Calico 插件时需要指定 "),n("code",[t._v("--pod-network-cidr=192.168.0.0/16")]),t._v("。")]),t._v(" "),n("p",[t._v("接下来使用 kubeadm init 命令，使用前面创建的配置文件进行集群的初始化：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("kubeadm init --config"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("init-config.yaml "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("tee")]),t._v(" kubeadm-init.log\n")])])]),n("p",[t._v("追加的 "),n("code",[t._v("tee kubeadm-init.log")]),t._v(" 用以输出日志。运行后，控制台将输出如下内容：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("root@k8s-master:/home/heyuqiang"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubeadm init --config=init-config.yaml | tee kubeadm-init.log")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("init"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Using Kubernetes version: v1.20.0\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("preflight"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Running pre-flight checks\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("WARNING SystemVerification"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": this Docker version is not on the list of validated versions: "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("20.10")]),t._v(".0. Latest validated version: "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("19.03")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("preflight"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Pulling images required "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" setting up a Kubernetes cluster\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("preflight"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" This might take a minute or two, depending on the speed of your internet connection\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("preflight"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" You can also perform this action "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" beforehand using "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kubeadm config images pull'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Using certificateDir folder "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/kubernetes/pki"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ca"')]),t._v(" certificate and key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiserver"')]),t._v(" certificate and key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" apiserver serving cert is signed "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" DNS names "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" and IPs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiserver-kubelet-client"')]),t._v(" certificate and key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"front-proxy-ca"')]),t._v(" certificate and key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"front-proxy-client"')]),t._v(" certificate and key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"etcd/ca"')]),t._v(" certificate and key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"etcd/server"')]),t._v(" certificate and key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" etcd/server serving cert is signed "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" DNS names "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k8s-master localhost"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" and IPs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101 "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1 ::1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"etcd/peer"')]),t._v(" certificate and key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" etcd/peer serving cert is signed "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" DNS names "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k8s-master localhost"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" and IPs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101 "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1 ::1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"etcd/healthcheck-client"')]),t._v(" certificate and key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiserver-etcd-client"')]),t._v(" certificate and key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sa"')]),t._v(" key and public key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubeconfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Using kubeconfig folder "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/kubernetes"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubeconfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Writing "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"admin.conf"')]),t._v(" kubeconfig "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubeconfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Writing "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubelet.conf"')]),t._v(" kubeconfig "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubeconfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Writing "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"controller-manager.conf"')]),t._v(" kubeconfig "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubeconfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Writing "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"scheduler.conf"')]),t._v(" kubeconfig "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubelet-start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Writing kubelet environment "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" with flags to "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/lib/kubelet/kubeadm-flags.env"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubelet-start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Writing kubelet configuration to "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/lib/kubelet/config.yaml"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubelet-start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Starting the kubelet\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("control-plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Using manifest folder "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/kubernetes/manifests"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("control-plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Creating static Pod manifest "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kube-apiserver"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("control-plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Creating static Pod manifest "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kube-controller-manager"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("control-plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Creating static Pod manifest "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kube-scheduler"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("etcd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Creating static Pod manifest "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("local")]),t._v(" etcd "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/kubernetes/manifests"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("wait-control-plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Waiting "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" the kubelet to boot up the control plane as static Pods from directory "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/kubernetes/manifests"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v(" This can take up to 4m0s\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("apiclient"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" All control plane components are healthy after "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("24.004707")]),t._v(" seconds\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("upload-config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Storing the configuration used "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" ConfigMap "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubeadm-config"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" the "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kube-system"')]),t._v(" Namespace\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubelet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Creating a ConfigMap "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubelet-config-1.20"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" namespace kube-system with the configuration "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" the kubelets "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" the cluster\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("upload-certs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Skipping phase. Please see --upload-certs\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("mark-control-plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Marking the "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" k8s-master as control-plane by adding the labels "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"node-role.kubernetes.io/master=''\"")]),t._v(" and "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"node-role.kubernetes.io/control-plane='' (deprecated)\"")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("mark-control-plane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Marking the "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" k8s-master as control-plane by adding the taints "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("node-role.kubernetes.io/master:NoSchedule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("bootstrap-token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Using token: abcdef.0123456789abcdef\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("bootstrap-token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("bootstrap-token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" configured RBAC rules to allow Node Bootstrap tokens to get nodes\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("bootstrap-token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" configured RBAC rules to allow Node Bootstrap tokens to post CSRs "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" order "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" nodes to get long term certificate credentials\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("bootstrap-token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("bootstrap-token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" configured RBAC rules to allow certificate rotation "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" all "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" client certificates "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" the cluster\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("bootstrap-token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Creating the "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cluster-info"')]),t._v(" ConfigMap "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" the "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kube-public"')]),t._v(" namespace\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubelet-finalize"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Updating "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/kubernetes/kubelet.conf"')]),t._v(" to point to a rotatable kubelet client certificate and key\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("addons"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Applied essential addon: CoreDNS\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("addons"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" -i /etc/kubernetes/admin.conf "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("chown")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" -u"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" -g"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n\nAlternatively, "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" you are the root user, you can run:\n\n  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("KUBECONFIG")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubectl apply -f [podnetwork].yaml"')]),t._v(" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nYou can now "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" any number of control-plane nodes by copying certificate authorities\nand "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" account keys on each "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" and "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v(" running the following as root:\n\n  kubeadm "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101:6443 --token abcdef.0123456789abcdef "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --discovery-token-ca-cert-hash sha256:cff67f08d748fb39c91199ce5515817dfffc5e6dd8a94448693fd3cbb6885eb3 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --control-plane \n\nThen you can "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" any number of worker nodes by running the following on each as root:\n\nkubeadm "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101:6443 --token abcdef.0123456789abcdef "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --discovery-token-ca-cert-hash sha256:cff67f08d748fb39c91199ce5515817dfffc5e6dd8a94448693fd3cbb6885eb3 \n")])])]),n("p",[t._v("这里有一个警告，意思是说Docker的版本不在Kubernetes的可用列表中，不过"),n("strong",[t._v("经过测试不影响使用")]),t._v("，强迫症可以选择降级Docker版本")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("[preflight] Running pre-flight checks\n        [WARNING SystemVerification]: this Docker version is not on the list of validated versions: 20.10.0. Latest validated version: 19.03\n")])])]),n("p",[t._v("这里来说明一下上图返回的信息中我们需要注意的地方：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 下面是成功完成第一个控制平面节点初始化的提示信息及后续需要完成的步骤")]),t._v("\nYour Kubernetes control-plane has initialized successfully"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 要开始使用群集，您需要以普通用户身份运行以下命令：")]),t._v("\nTo start using your cluster, you need to run the following as a regular user:\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Setup 1 : 复制Kubernetes集群管理员认证到Kubernetes集群时使用的kubeconfig配置文件：")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" -i /etc/kubernetes/admin.conf "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("chown")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" -u"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" -g"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 我们也可以不做上述设定，而使用环境变量KUBECONFIG为kubelet等指定默认使用的kubeconfig：")]),t._v("\nAlternatively, "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" you are the root user, you can run:\n\n  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("KUBECONFIG")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/kubernetes/admin.conf\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Setup 2 : 管理员需要使用网络插件为Kubernetes集群部署Pod网络，具体选用的插件取决于管理员：")]),t._v("\nYou should now deploy a pod network to the cluster.\nRun "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubectl apply -f [podnetwork].yaml"')]),t._v(" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Setup 3 : 使用root用户身份运行一下命令，可以通过证书认证方式添加控制节点：")]),t._v("\nYou can now "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" any number of control-plane nodes by copying certificate authorities\nand "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" account keys on each "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" and "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v(" running the following as root:\n\n  kubeadm "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101:6443 --token abcdef.0123456789abcdef "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --discovery-token-ca-cert-hash sha256:cff67f08d748fb39c91199ce5515817dfffc5e6dd8a94448693fd3cbb6885eb3 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --control-plane \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Setup 4 : 使用root用户身份运行一下命令，可以通过证书认证方式添加任意数量的工作节点：")]),t._v("\nThen you can "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" any number of worker nodes by running the following on each as root:\n\nkubeadm "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101:6443 --token abcdef.0123456789abcdef "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --discovery-token-ca-cert-hash sha256:cff67f08d748fb39c91199ce5515817dfffc5e6dd8a94448693fd3cbb6885eb3 \n")])])]),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),n("p",[t._v("记录下初始化结果中的kubeadm join命令，部署worker节点时会用到")])]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),n("p",[t._v("如果安装 kubernetes 版本和下载的镜像版本不统一则会出现 "),n("code",[t._v("timed out waiting for the condition")]),t._v(" 错误。中途失败或是想修改配置可以使用 "),n("code",[t._v("kubeadm reset")]),t._v(" 命令重置配置，再做初始化操作即可。")])]),t._v(" "),n("h2",{attrs:{id:"配置-kubectl"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置-kubectl"}},[t._v("#")]),t._v(" 配置 kubectl")]),t._v(" "),n("p",[n("code",[t._v("kubectl")]),t._v(" 是管理 Kubernetes Cluster 的命令行工具，前面我们已经在所有的节点安装了 "),n("code",[t._v("kubectl")]),t._v("。Master 初始化完成后需要做一些配置工作，然后 "),n("code",[t._v("kubectl")]),t._v(" 就能使用了。\n依照 "),n("code",[t._v("kubeadm init")]),t._v(" 输出的最后提示，"),n("strong",[t._v("推荐用 Linux 普通用户执行")]),t._v(" "),n("code",[t._v("kubectl")]),t._v("。")]),t._v(" "),n("p",[t._v("切换到普通用户"),n("code",[t._v("ubuntu")]),t._v("，保存集群安全配置文件到当前用户.kube目录")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("su")]),t._v(" - ubuntu\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" -i /etc/kubernetes/admin.conf "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("chown")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" -u"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" -g"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#启用 kubectl 命令自动补全功能（注销重新登录生效）")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"source <(kubectl completion bash)"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" ~/.bashrc\n")])])]),n("p",[t._v("需要这些配置命令的原因是：Kubernetes 集群默认需要加密方式访问。所以，这几条命令，就是将刚刚部署生成的 Kubernetes 集群的安全配置文件，保存到当前用户的 "),n("code",[t._v(".kube")]),t._v(" 目录下，"),n("code",[t._v("kubectl")]),t._v(" 默认会使用这个目录下的授权信息访问 Kubernetes 集群。\n如果不这么做的话，我们每次都需要通过 "),n("code",[t._v("export KUBECONFIG")]),t._v(" 环境变量告诉 "),n("code",[t._v("kubectl")]),t._v(" 这个安全配置文件的位置。\n配置完成后 "),n("code",[t._v("ubuntu")]),t._v(" 用户就可以使用 "),n("code",[t._v("kubectl")]),t._v(" 命令管理集群了。")]),t._v(" "),n("h2",{attrs:{id:"验证是否成功"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证是否成功"}},[t._v("#")]),t._v(" 验证是否成功")]),t._v(" "),n("p",[t._v("确认各个组件都处于healthy状态。\n查看节点状态")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ubuntu@k8s-master ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("$ kubectl get nodes\nNAME         STATUS     ROLES    AGE   VERSION\nk8s-master   Ready   master   23m   v1.20.0\n")])])]),n("p",[t._v("可以看到，当前只存在1个master节点，并且这个节点的状态是 NotReady。\n使用 "),n("code",[t._v("kubectl describe")]),t._v(" 命令来查看这个节点（Node）对象的详细信息、状态和事件（Event）：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("ubuntu@k8s-master:~/.kube$ kubectl describe "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" k8s-master\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("\nEvents:\n  Type    Reason                   Age                From        Message\n  ----    ------                   ----               ----        -------\n  Normal  NodeHasSufficientMemory  43m "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x7 over 43m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  kubelet     Node k8s-master status is now: NodeHasSufficientMemory\n  Normal  NodeHasNoDiskPressure    43m "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x7 over 43m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  kubelet     Node k8s-master status is now: NodeHasNoDiskPressure\n  Normal  NodeHasSufficientPID     43m "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x7 over 43m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  kubelet     Node k8s-master status is now: NodeHasSufficientPID\n  Normal  Starting                 42m                kubelet     Starting kubelet.\n  Normal  NodeHasSufficientMemory  42m                kubelet     Node k8s-master status is now: NodeHasSufficientMemory\n  Normal  NodeHasNoDiskPressure    42m                kubelet     Node k8s-master status is now: NodeHasNoDiskPressure\n  Normal  NodeHasSufficientPID     42m                kubelet     Node k8s-master status is now: NodeHasSufficientPID\n  Normal  NodeAllocatableEnforced  42m                kubelet     Updated Node Allocatable limit across pods\n  Normal  Starting                 42m                kube-proxy  Starting kube-proxy.\n")])])]),n("p",[t._v("通过 "),n("code",[t._v("kubectl describe")]),t._v(" 指令的输出，我们可以看到 "),n("code",[t._v("NodeNotReady")]),t._v(" 的原因在于，我们尚未部署任何网络插件，"),n("code",[t._v("kube-proxy")]),t._v(" 等组件还处于 "),n("code",[t._v("starting")]),t._v(" 状态。")]),t._v(" "),n("p",[t._v("另外，我们还可以通过 "),n("code",[t._v("kubectl")]),t._v(" 检查这个节点上各个系统 Pod 的状态，其中，"),n("code",[t._v("kube-system")]),t._v(" 是 Kubernetes 项目预留的系统 Pod 的工作空间（"),n("code",[t._v("Namespace")]),t._v("，注意它并不是 Linux Namespace，它只是 Kubernetes 划分不同工作空间的单位）：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("kubectl get pod -n kube-system -o wide\n")])])]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("ubuntu@k8s-master:~$ kubectl get pod -n kube-system -o wide\nNAME                                      READY   STATUS    RESTARTS   AGE   IP           NODE              NOMINATED NODE   READINESS GATES\ncoredns-7f89b7bc75-d4drw                  "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Pending   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          44m   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("            "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\ncoredns-7f89b7bc75-xzjfp                  "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Pending   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          44m   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("            "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\netcd-k8s-master                      "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          44m   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101   k8s-master   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nkube-apiserver-k8s-master            "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          44m   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101   k8s-master   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nkube-controller-manager-k8s-master   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          44m   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101   k8s-master   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nkube-proxy-55q6f                          "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          44m   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101   k8s-master   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nkube-scheduler-k8s-master            "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          44m   "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".31.101   k8s-master   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),n("p",[t._v("可以看到，"),n("code",[t._v("CoreDNS")]),t._v(" 依赖于网络的 Pod 都处于 "),n("code",[t._v("Pending")]),t._v(" 状态，即调度失败。这当然是符合预期的：因为这个 Master 节点的网络尚未就绪。")]),t._v(" "),n("p",[t._v("至此主节点配置完成。")]),t._v(" "),n("h2",{attrs:{id:"kubeadm-init-的执行过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#kubeadm-init-的执行过程"}},[t._v("#")]),t._v(" kubeadm init 的执行过程")]),t._v(" "),n("ul",[n("li",[t._v("init：指定版本进行初始化操作")]),t._v(" "),n("li",[t._v("preflight：初始化前的检查和下载所需要的 Docker 镜像文件")]),t._v(" "),n("li",[t._v("kubelet-start：生成 kubelet 的配置文件 "),n("code",[t._v("var/lib/kubelet/config.yaml")]),t._v("，没有这个文件 kubelet 无法启动，所以初始化之前的 kubelet 实际上启动不会成功")]),t._v(" "),n("li",[t._v("certificates：生成 Kubernetes 使用的证书，存放在 "),n("code",[t._v("/etc/kubernetes/pki")]),t._v(" 目录中")]),t._v(" "),n("li",[t._v("kubeconfig：生成 KubeConfig 文件，存放在 "),n("code",[t._v("/etc/kubernetes")]),t._v(" 目录中，组件之间通信需要使用对应文件")]),t._v(" "),n("li",[t._v("control-plane：使用 "),n("code",[t._v("/etc/kubernetes/manifest")]),t._v(" 目录下的 YAML 文件，安装 Master 组件")]),t._v(" "),n("li",[t._v("etcd：使用 "),n("code",[t._v("/etc/kubernetes/manifest/etcd.yaml")]),t._v(" 安装 Etcd 服务")]),t._v(" "),n("li",[t._v("wait-control-plane：等待 control-plan 部署的 Master 组件启动")]),t._v(" "),n("li",[t._v("apiclient：检查 Master 组件服务状态。")]),t._v(" "),n("li",[t._v("uploadconfig：更新配置")]),t._v(" "),n("li",[t._v("kubelet：使用 configMap 配置 kubelet")]),t._v(" "),n("li",[t._v("patchnode：更新 CNI 信息到 Node 上，通过注释的方式记录")]),t._v(" "),n("li",[t._v("mark-control-plane：为当前节点打标签，打了角色 Master，和不可调度标签，这样默认就不会使用 Master 节点来运行 Pod")]),t._v(" "),n("li",[t._v("bootstrap-token：生成 token 记录下来，后边使用 "),n("code",[t._v("kubeadm join")]),t._v(" 往集群中添加节点时会用到")]),t._v(" "),n("li",[t._v("addons：安装附加组件 CoreDNS 和 kube-proxy")])])])}),[],!1,null,null,null);s.default=a.exports}}]);