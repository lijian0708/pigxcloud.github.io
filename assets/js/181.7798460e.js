(window.webpackJsonp=window.webpackJsonp||[]).push([[181],{650:function(s,t,e){"use strict";e.r(t);var a=e(29),n=Object(a.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"使用-kubeadm-配置-worker-节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-kubeadm-配置-worker-节点"}},[s._v("#")]),s._v(" 使用 kubeadm 配置 Worker 节点")]),s._v(" "),e("h2",{attrs:{id:"概述"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),e("p",[s._v("部署worker节点 Kubernetes 的 Worker 节点跟 Master 节点几乎是相同的，它们运行着的都是一个 kubelet 组件。唯一的区别在于，在 kubeadm init 的过程中，kubelet 启动后，Master 节点上还会自动运行 kube-apiserver、kube-scheduler、kube-controller-manger 这三个系统 Pod。 在 k8s-node1 和 k8s-node2 上分别执行如下命令，将其注册到 Cluster 中：")]),s._v(" "),e("h2",{attrs:{id:"加入集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#加入集群"}},[s._v("#")]),s._v(" 加入集群")]),s._v(" "),e("p",[s._v("执行以下命令将节点接入集群")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubeadm "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.101:6443 --token abcdef.0123456789abcdef "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --discovery-token-ca-cert-hash sha256:d7df0d887d0407995eb46df24d3481c5e9b6ffc13da97be7f5f685f3aca1d8e7 \n")])])]),e("p",[s._v("如果执行kubeadm init时没有记录下加入集群的命令，可以通过以下命令重新创建 "),e("code",[s._v("kubeadm token create --print-join-command")]),s._v(" 在k8s-node1上执行kubeadm join ：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node1 ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm join 192.168.199.101:6443 --token abcdef.0123456789abcdef \\")]),s._v("\n    --discovery-token-ca-cert-hash sha256:d7df0d887d0407995eb46df24d3481c5e9b6ffc13da97be7f5f685f3aca1d8e7 \nW0419 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":00:43.118672   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("32562")]),s._v(" join.go:346"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" WARNING: JoinControlPane.controlPlane settings will be ignored when control-plane flag is not set.\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Running pre-flight checks\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING IsDockerSystemdCheck"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": detected "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cgroupfs"')]),s._v(" as the Docker cgroup driver. The recommended driver is "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"systemd"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" Please follow the guide at https://kubernetes.io/docs/setup/cri/\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Reading configuration from the cluster"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" FYI: You can "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("look")]),s._v(" at this config "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" with "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl -n kube-system get cm kubeadm-config -oyaml'")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Downloading configuration "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the kubelet from the "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubelet-config-1.18"')]),s._v(" ConfigMap "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" the kube-system namespace\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Writing kubelet configuration to "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/kubelet/config.yaml"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Writing kubelet environment "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" with flags to "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/kubelet/kubeadm-flags.env"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Starting the kubelet\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Waiting "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the kubelet to perform the TLS Bootstrap"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nThis "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl get nodes'")]),s._v(" on the control-plane to see this "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" the cluster.\n")])])]),e("p",[s._v("重复执行以上操作将k8s-node2也加进去（注意重新执行"),e("code",[s._v("kubeadm token create --print-join-command")]),s._v("）。 然后根据提示，我们可以通过 kubectl get nodes 查看节点的状态：")]),s._v(" "),e("p",[s._v("说明：")]),s._v(" "),e("ul",[e("li",[s._v("token\n"),e("ul",[e("li",[s._v("可以通过安装 master 时的日志查看 token 信息")]),s._v(" "),e("li",[s._v("可以通过 "),e("code",[s._v("kubeadm token list")]),s._v(" 命令打印出 token 信息")]),s._v(" "),e("li",[s._v("如果 token 过期，可以使用 "),e("code",[s._v("kubeadm token create")]),s._v(" 命令创建新的 token")])])]),s._v(" "),e("li",[s._v("discovery-token-ca-cert-hash\n"),e("ul",[e("li",[s._v("可以通过安装 master 时的日志查看 sha256 信息")]),s._v(" "),e("li",[s._v("可以通过 "),e("code",[s._v("openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'")]),s._v(" 命令查看 sha256 信息")])])])]),s._v(" "),e("h2",{attrs:{id:"验证是否成功"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证是否成功"}},[s._v("#")]),s._v(" 验证是否成功")]),s._v(" "),e("p",[s._v("回到 master 服务器,可以看到 node 成功加入 master")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get nodes\nNAME         STATUS   ROLES    AGE     VERSION\nk8s-master   Ready    master   38m     v1.18.2\nk8s-node1    Ready    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   7m57s   v1.18.2\nk8s-node2    Ready    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   7m37s   v1.18.2\n")])])]),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),e("p",[s._v("如果 node 节点加入 master 时配置有问题可以在 node 节点上使用 "),e("code",[s._v("kubeadm reset")]),s._v(" 重置配置再使用 "),e("code",[s._v("kubeadm join")]),s._v(" 命令重新加入即可。希望在 master 节点删除 node ，可以使用 "),e("code",[s._v("kubeadm delete nodes")]),s._v(" 删除。")])]),s._v(" "),e("p",[s._v("nodes状态全部为ready，由于每个节点都需要启动若干组件，如果node节点的状态是 NotReady，可以查看所有节点pod状态，确保所有pod成功拉取到镜像并处于running状态：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get pod --all-namespaces -o wide\nNAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE   IP                NODE         NOMINATED NODE   READINESS GATES\nkube-system   calico-kube-controllers-555fc8cc5c-mcmst   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          66m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".235.193    k8s-master   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   calico-node-lh5j2                          "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          37m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.102   k8s-node1    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   calico-node-s76tm                          "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          66m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.101   k8s-master   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   calico-node-wd4rj                          "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          36m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.103   k8s-node2    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   coredns-7ff77c879f-h95kn                   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".235.195    k8s-master   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   coredns-7ff77c879f-lczbq                   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".235.194    k8s-master   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   etcd-k8s-master                            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.101   k8s-master   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-apiserver-k8s-master                  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.101   k8s-master   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-controller-manager-k8s-master         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.101   k8s-master   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-proxy-2kg9t                           "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.101   k8s-master   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-proxy-7fkx9                           "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          36m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.103   k8s-node2    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-proxy-mcjc5                           "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          37m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.102   k8s-node1    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkube-system   kube-scheduler-k8s-master                  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.101   k8s-master   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])]),e("p",[s._v("这时，所有的节点都已经 Ready，Kubernetes Cluster 创建成功，一切准备就绪。 如果pod状态为Pending、ContainerCreating、ImagePullBackOff 都表明 Pod 没有就绪，Running 才是就绪状态。 如果有pod提示Init:ImagePullBackOff，说明这个pod的镜像在对应节点上拉取失败，我们可以通过 kubectl describe pod 查看 Pod 具体情况，以确认拉取失败的镜像：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl describe pod calico-node-lh5j2 --namespace"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-system\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nEvents:\n  Type     Reason     Age   From                Message\n  ----     ------     ----  ----                -------\n  Normal   Scheduled  42m   default-scheduler   Successfully assigned kube-system/calico-node-lh5j2 to k8s-node1\n  Normal   Pulling    42m   kubelet, k8s-node1  Pulling image "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"calico/cni:v3.13.2"')]),s._v("\n  Normal   Pulled     37m   kubelet, k8s-node1  Successfully pulled image "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"calico/cni:v3.13.2"')]),s._v("\n  Normal   Created    37m   kubelet, k8s-node1  Created container upgrade-ipam\n  Normal   Started    37m   kubelet, k8s-node1  Started container upgrade-ipam\n  Normal   Pulled     37m   kubelet, k8s-node1  Container image "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"calico/cni:v3.13.2"')]),s._v(" already present on machine\n  Normal   Created    37m   kubelet, k8s-node1  Created container install-cni\n  Normal   Started    37m   kubelet, k8s-node1  Started container install-cni\n  Normal   Pulling    37m   kubelet, k8s-node1  Pulling image "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"calico/pod2daemon-flexvol:v3.13.2"')]),s._v("\n  Normal   Pulled     37m   kubelet, k8s-node1  Successfully pulled image "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"calico/pod2daemon-flexvol:v3.13.2"')]),s._v("\n  Normal   Created    37m   kubelet, k8s-node1  Created container flexvol-driver\n  Normal   Started    37m   kubelet, k8s-node1  Started container flexvol-driver\n  Normal   Pulling    37m   kubelet, k8s-node1  Pulling image "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"calico/node:v3.13.2"')]),s._v("\n  Normal   Pulled     33m   kubelet, k8s-node1  Successfully pulled image "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"calico/node:v3.13.2"')]),s._v("\n  Normal   Created    33m   kubelet, k8s-node1  Created container calico-node\n  Normal   Started    33m   kubelet, k8s-node1  Started container calico-node\n  Warning  Unhealthy  33m   kubelet, k8s-node1  Readiness probe failed: calico/node is not ready: BIRD is not ready: BGP not established with "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.1032020-04-19 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":10:12.409 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("168")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" health.go "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("156")]),s._v(": Number of node"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" with BGP peering established "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])])]),e("p",[s._v("查看master节点下载了哪些镜像")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$  "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" images\nREPOSITORY                                                        TAG                 IMAGE ID            CREATED             SIZE\ncalico/pod2daemon-flexvol                                         v3.13.2             77a3fabf99a5        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" weeks ago         111MB\ncalico/cni                                                        v3.13.2             a89faaa1676a        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" weeks ago         224MB\ncalico/kube-controllers                                           v3.13.2             0c3bf0adad2b        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" weeks ago         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),s._v(".6MB\ncalico/node                                                       v3.13.2             6f674c890b23        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" weeks ago         260MB\nregistry.aliyuncs.com/google_containers/kube-proxy                v1.18.0             43940c34f24f        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago         117MB\nregistry.aliyuncs.com/google_containers/kube-apiserver            v1.18.0             74060cea7f70        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago         173MB\nregistry.aliyuncs.com/google_containers/kube-scheduler            v1.18.0             a31f78c7c8ce        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("95")]),s._v(".3MB\nregistry.aliyuncs.com/google_containers/kube-controller-manager   v1.18.0             d3e55153f52f        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago         162MB\nregistry.aliyuncs.com/google_containers/pause                     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.2")]),s._v("                 80d28bedfe5d        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" months ago        683kB\nregistry.aliyuncs.com/google_containers/coredns                   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.6")]),s._v(".7               67da37a9a360        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" months ago        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("43")]),s._v(".8MB\nregistry.aliyuncs.com/google_containers/etcd                      "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.4")]),s._v(".3-0             303ce5db0e90        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" months ago        288MB\n")])])]),e("p",[s._v("查看worker节点下载了哪些镜像：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node1 ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  sudo docker images")]),s._v("\nREPOSITORY                                                        TAG                 IMAGE ID            CREATED             SIZE\ncalico/pod2daemon-flexvol                                         v3.13.2             77a3fabf99a5        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" weeks ago         111MB\ncalico/cni                                                        v3.13.2             a89faaa1676a        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" weeks ago         224MB\ncalico/node                                                       v3.13.2             6f674c890b23        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" weeks ago         260MB\nregistry.aliyuncs.com/google_containers/kube-proxy                v1.18.0             43940c34f24f        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago         117MB\nregistry.aliyuncs.com/google_containers/kube-controller-manager   v1.18.0             d3e55153f52f        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago         162MB\nregistry.aliyuncs.com/google_containers/kube-scheduler            v1.18.0             a31f78c7c8ce        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("95")]),s._v(".3MB\nregistry.aliyuncs.com/google_containers/kube-apiserver            v1.18.0             74060cea7f70        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" weeks ago         173MB\nregistry.aliyuncs.com/google_containers/pause                     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.2")]),s._v("                 80d28bedfe5d        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" months ago        683kB\nregistry.aliyuncs.com/google_containers/coredns                   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.6")]),s._v(".7               67da37a9a360        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" months ago        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("43")]),s._v(".8MB\nregistry.aliyuncs.com/google_containers/etcd                      "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.4")]),s._v(".3-0             303ce5db0e90        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" months ago        288MB\n")])])]),e("h2",{attrs:{id:"测试集群各个组件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#测试集群各个组件"}},[s._v("#")]),s._v(" 测试集群各个组件")]),s._v(" "),e("p",[s._v("首先验证"),e("code",[s._v("kube-apiserver")]),s._v(", "),e("code",[s._v("kube-controller-manager")]),s._v(", "),e("code",[s._v("kube-scheduler")]),s._v(", "),e("code",[s._v("pod network")]),s._v(" 是否正常： 部署一个 Nginx Deployment，包含2个Pod 参考："),e("a",{attrs:{href:"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://kubernetes.io/docs/concepts/workloads/controllers/deployment/"),e("OutboundLink")],1)]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl create deployment nginx --image"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:alpine\ndeployment.apps/nginx created\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl scale deployment nginx --replicas"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\ndeployment.apps/nginx scaled\n")])])]),e("p",[s._v("验证Nginx Pod是否正确运行，并且会分配10.244.开头的集群IP")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get pods -l "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx -o wide      \nNAME                     READY   STATUS    RESTARTS   AGE     IP               NODE        NOMINATED NODE   READINESS GATES\nnginx-745b4df97d-jb5f4   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3m10s   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".169.129   k8s-node2   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nnginx-745b4df97d-zgdbr   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          2m29s   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".36.65     k8s-node1   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])]),e("h2",{attrs:{id:"验证kube-proxy"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证kube-proxy"}},[s._v("#")]),s._v(" 验证kube-proxy")]),s._v(" "),e("p",[s._v("以 NodePort 方式对外提供服务 参考："),e("a",{attrs:{href:"https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/"),e("OutboundLink")],1)]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl expose deployment nginx --port"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" --type"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NodePort\nservice/nginx exposed\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get services nginx\nNAME    TYPE       CLUSTER-IP   EXTERNAL-IP   PORT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("        AGE\nnginx   NodePort   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.97")]),s._v(".5.8    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":32350/TCP   19s\n")])])]),e("p",[s._v("可以通过任意 NodeIP:Port 在集群外部访问这个服务：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.101:32350\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.102:32350\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".199.103:32350\n")])])]),e("p",[s._v("最后验证一下dns, pod network是否正常： 运行Busybox并进入交互模式")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl run -it "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" --image"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("radial/busyboxplus:curl\nIf you don't see a "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" prompt, try pressing enter.\n")])])]),e("p",[s._v("输入nslookup nginx查看是否可以正确解析出集群内的IP，以验证DNS是否正常")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" root@curl:/ "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("nslookup")]),s._v(" nginx\nServer:    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.10\nAddress "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.10 kube-dns.kube-system.svc.cluster.local\n\nName:      nginx\nAddress "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.97")]),s._v(".5.8 nginx.default.svc.cluster.local\n")])])]),e("p",[s._v("通过服务名进行访问，验证kube-proxy是否正常")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" root@curl:/ "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://nginx/\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("DOCTYPE html"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("html"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("head"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("title"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("Welcome to nginx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/title"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/body"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/html"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 分别访问一下2个Pod的内网IP，验证跨Node的网络通信是否正常")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" root@curl:/ "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".169.129\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("DOCTYPE html"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("html"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("head"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("title"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("Welcome to nginx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/title"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/body"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/html"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" root@curl:/ "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".36.65\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("DOCTYPE html"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("html"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("head"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("title"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("Welcome to nginx"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/title"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/body"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/html"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])]),e("h2",{attrs:{id:"停止服务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#停止服务"}},[s._v("#")]),s._v(" 停止服务")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl delete deployment nginx\ndeployment.apps "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx"')]),s._v(" deleted\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl delete "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" nginx\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx"')]),s._v(" deleted\n")])])]),e("h2",{attrs:{id:"pod调度到master节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pod调度到master节点"}},[s._v("#")]),s._v(" Pod调度到Master节点")]),s._v(" "),e("p",[s._v("出于安全考虑，默认配置下Kubernetes不会将Pod调度到Master节点。查看Taints字段默认配置：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl describe "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-master \n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nTaints:             node-role.kubernetes.io/master:NoSchedule\n")])])]),e("p",[s._v("如果希望将k8s-master也当作Node节点使用，可以执行如下命令,其中k8s-master是主机节点hostname：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl taint "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-master node-role.kubernetes.io/master-\n")])])]),e("p",[s._v("修改后Taints字段状态：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl describe "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-master                             \n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nTaints:             "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])]),e("p",[s._v("如果要恢复Master Only状态，执行如下命令：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl taint "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-master node-role.kubernetes.io/master"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(":NoSchedule\n")])])]),e("h2",{attrs:{id:"kube-proxy开启ipvs"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kube-proxy开启ipvs"}},[s._v("#")]),s._v(" kube-proxy开启ipvs")]),s._v(" "),e("p",[s._v("修改ConfigMap的kube-system/kube-proxy中的config.conf，mode: “ipvs”：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl edit cm kube-proxy -n kube-system\nconfigmap/kube-proxy edited\n之后重启各个节点上的kube-proxy pod：\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get pod -n kube-system "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kube-proxy "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{system("kubectl delete pod "$1" -n kube-system")}\'')]),s._v("\npod "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kube-proxy-2w9sh"')]),s._v(" deleted\npod "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kube-proxy-gw4lx"')]),s._v(" deleted\npod "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kube-proxy-thv4c"')]),s._v(" deleted\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get pod -n kube-system "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kube-proxy\nkube-proxy-6qlgv                        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          65s\nkube-proxy-fdtjd                        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          47s\nkube-proxy-m8zkx                        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          52s\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$\n")])])]),e("p",[s._v("查看日志：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl logs kube-proxy-6qlgv -n kube-system\nI1213 09:50:15.414493       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" server_others.go:189"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Using ipvs Proxier.\nW1213 09:50:15.414908       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" proxier.go:365"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" IPVS scheduler not specified, use rr by default\nI1213 09:50:15.415021       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" server_others.go:216"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Tearing down inactive rules.\nI1213 09:50:15.461658       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" server.go:464"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Version: v1.13.0\nI1213 09:50:15.467827       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" conntrack.go:52"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Setting nf_conntrack_max to "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\nI1213 09:50:15.467997       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" config.go:202"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Starting "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" config controller\nI1213 09:50:15.468010       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" controller_utils.go:1027"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Waiting "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" caches to "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sync")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" config controller\nI1213 09:50:15.468092       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" config.go:102"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Starting endpoints config controller\nI1213 09:50:15.468100       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" controller_utils.go:1027"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Waiting "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" caches to "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sync")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" endpoints config controller\nI1213 09:50:15.568766       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" controller_utils.go:1034"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Caches are synced "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" endpoints config controller\nI1213 09:50:15.568950       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" controller_utils.go:1034"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Caches are synced "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" config controller\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos@k8s-master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$\n")])])]),e("p",[s._v("日志中打印出了Using ipvs Proxier，说明ipvs模式已经开启。")]),s._v(" "),e("h2",{attrs:{id:"移除节点和集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#移除节点和集群"}},[s._v("#")]),s._v(" 移除节点和集群")]),s._v(" "),e("p",[s._v("kubernetes集群移除节点，以移除k8s-node2节点为例，在Master节点上运行：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl drain k8s-node2 --delete-local-data --force --ignore-daemonsets\nkubectl delete "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" k8s-node2\n")])])]),e("p",[s._v("上面两条命令执行完成后，在k8s-node2节点执行清理命令，重置kubeadm的安装状态：")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubeadm reset\n")])])]),e("p",[s._v("在master上删除node并不会清理k8s-node2运行的容器，需要在删除节点上面手动运行清理命令。\n如果你想重新配置集群，使用新的参数重新运行"),e("code",[s._v("kubeadm init")]),s._v("或者"),e("code",[s._v("kubeadm join")]),s._v("即可。")]),s._v(" "),e("p",[s._v("至此3个节点的集群搭建完成，后续可以继续添加node节点，或者部署"),e("code",[s._v("dashboard")]),s._v("、"),e("code",[s._v("helm")]),s._v("包管理工具、"),e("code",[s._v("EFK")]),s._v("日志系统、"),e("code",[s._v("Prometheus Operator")]),s._v("监控系统、"),e("code",[s._v("rook+ceph")]),s._v("存储系统等组件。")])])}),[],!1,null,null,null);t.default=n.exports}}]);